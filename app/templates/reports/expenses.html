{% extends "base.html" %}

{% block title %}{{ _('reports.expense_analysis') }} — {{ _('app_name') }}{% endblock %}
{% block page_title %}{{ _('reports.expense_analysis') }}{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav class="mb-4 text-sm">
    <ol class="flex items-center gap-2 text-gray-500 dark:text-gray-400">
        <li><a href="/reports" class="hover:text-primary-600 dark:hover:text-primary-400">{{ _('nav.reports') }}</a></li>
        <li><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></li>
        <li class="text-gray-900 dark:text-white font-medium">{{ _('reports.expense_analysis') }}</li>
    </ol>
</nav>

<!-- Date Filters -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 mb-6">
    <form method="GET" class="flex flex-wrap items-end gap-4">
        <div>
            <label for="start_date" class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">{{ _('reports.start_date') }}</label>
            <input type="date" id="start_date" name="start_date" value="{{ start_date or '' }}"
                   class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
        </div>
        <div>
            <label for="end_date" class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">{{ _('reports.end_date') }}</label>
            <input type="date" id="end_date" name="end_date" value="{{ end_date or '' }}"
                   class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
        </div>
        <button type="submit" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white text-sm rounded-lg font-medium transition-colors">
            {{ _('btn.filter') }}
        </button>
        <a href="/reports/expenses" class="px-4 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            {{ _('btn.reset') }}
        </a>

        <!-- Export buttons -->
        <div class="ml-auto flex items-center gap-2">
            <a href="/reports/expenses/export/excel?start_date={{ start_date or '' }}&end_date={{ end_date or '' }}"
               class="inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-green-700 dark:text-green-400 bg-green-50 dark:bg-green-900/20 hover:bg-green-100 dark:hover:bg-green-900/40 rounded-lg border border-green-200 dark:border-green-800 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                {{ _('reports.export_excel') }}
            </a>
            <a href="/reports/expenses/export/csv?start_date={{ start_date or '' }}&end_date={{ end_date or '' }}"
               class="inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg border border-gray-200 dark:border-gray-600 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                {{ _('reports.export_csv') }}
            </a>
        </div>
    </form>
</div>

<!-- Date range indicator -->
{% if start_date or end_date %}
<div class="mb-4 flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
    </svg>
    <span>{{ _('reports.period') }}: {{ start_date or _('reports.all_time') }} — {{ end_date or _('reports.present') }}</span>
</div>
{% endif %}

<!-- Summary Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-5">
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">{{ _('reports.grand_total') }}</p>
        <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ "{:,.0f}".format(data.grand_total) }} <span class="text-sm font-normal text-gray-400">KZT</span></p>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-5">
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">{{ _('reports.total_transactions') }}</p>
        <p class="text-2xl font-bold text-primary-600 dark:text-primary-400">{{ "{:,}".format(data.total_count) }}</p>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-5">
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">{{ _('reports.categories_count') }}</p>
        <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ data.by_category|length }}</p>
    </div>
</div>

<!-- Charts and Category Breakdown Grid -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Category Breakdown Table -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
        <div class="px-5 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-sm font-semibold text-gray-900 dark:text-white">{{ _('reports.by_category') }}</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
                        <th class="px-4 py-3 text-left font-medium text-gray-500 dark:text-gray-400">{{ _('reports.category') }}</th>
                        <th class="px-4 py-3 text-right font-medium text-gray-500 dark:text-gray-400">{{ _('reports.amount') }} (KZT)</th>
                        <th class="px-4 py-3 text-center font-medium text-gray-500 dark:text-gray-400">{{ _('reports.count') }}</th>
                        <th class="px-4 py-3 text-right font-medium text-gray-500 dark:text-gray-400">{{ _('reports.share') }}</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                    {% for row in data.by_category %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full
                                    {% if row.category == 'fuel' %}bg-blue-500
                                    {% elif row.category == 'parts' %}bg-orange-500
                                    {% elif row.category == 'service' %}bg-green-500
                                    {% elif row.category == 'insurance' %}bg-purple-500
                                    {% elif row.category == 'tax' %}bg-red-500
                                    {% elif row.category == 'fine' %}bg-pink-500
                                    {% elif row.category == 'parking' %}bg-cyan-500
                                    {% elif row.category == 'toll' %}bg-indigo-500
                                    {% elif row.category == 'washing' %}bg-teal-500
                                    {% else %}bg-gray-500{% endif %}
                                "></div>
                                <span class="font-medium text-gray-900 dark:text-white">{{ _('expense_category.' + row.category) }}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-right font-mono text-gray-700 dark:text-gray-300">{{ "{:,.0f}".format(row.total) }}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="inline-flex items-center justify-center min-w-[2rem] px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300">
                                {{ row.count }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-right text-gray-500 dark:text-gray-400">
                            {% if data.grand_total > 0 %}
                            {{ "{:.1f}".format(row.total / data.grand_total * 100) }}%
                            {% else %}
                            0%
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="px-4 py-8 text-center text-gray-400 dark:text-gray-500">{{ _('common.no_data') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                {% if data.by_category %}
                <tfoot>
                    <tr class="bg-gray-50 dark:bg-gray-900/50 border-t-2 border-gray-300 dark:border-gray-600">
                        <td class="px-4 py-3 font-semibold text-gray-900 dark:text-white">{{ _('reports.total') }}</td>
                        <td class="px-4 py-3 text-right font-mono font-bold text-gray-900 dark:text-white">{{ "{:,.0f}".format(data.grand_total) }}</td>
                        <td class="px-4 py-3 text-center font-semibold text-gray-900 dark:text-white">{{ data.total_count }}</td>
                        <td class="px-4 py-3 text-right font-semibold text-gray-500 dark:text-gray-400">100%</td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
    </div>

    <!-- Category Pie/Doughnut Chart -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-5">
        <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-4">{{ _('reports.expense_distribution') }}</h3>
        {% if data.by_category %}
        <div class="relative" style="height: 300px;">
            <canvas id="categoryChart"></canvas>
        </div>
        {% else %}
        <div class="flex items-center justify-center" style="height: 300px;">
            <p class="text-gray-400 dark:text-gray-500">{{ _('common.no_data') }}</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Monthly Trend Chart -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-5 mb-6">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-sm font-semibold text-gray-900 dark:text-white">{{ _('reports.monthly_trend') }}</h3>
        {% if data.monthly %}
        <div class="flex items-center gap-4 text-xs text-gray-500 dark:text-gray-400">
            <div class="flex items-center gap-1.5">
                <div class="w-3 h-3 rounded bg-primary-500"></div>
                <span>{{ _('reports.amount') }}</span>
            </div>
            <div class="flex items-center gap-1.5">
                <div class="w-3 h-3 rounded bg-gray-300 dark:bg-gray-600"></div>
                <span>{{ _('reports.count') }}</span>
            </div>
        </div>
        {% endif %}
    </div>
    {% if data.monthly %}
    <div class="relative" style="height: 320px;">
        <canvas id="monthlyChart"></canvas>
    </div>
    {% else %}
    <div class="flex items-center justify-center" style="height: 320px;">
        <svg class="w-12 h-12 text-gray-300 dark:text-gray-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
        </svg>
        <p class="text-gray-400 dark:text-gray-500">{{ _('common.no_data') }}</p>
    </div>
    {% endif %}
</div>

<!-- Monthly Detail Table -->
{% if data.monthly %}
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
    <div class="px-5 py-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-sm font-semibold text-gray-900 dark:text-white">{{ _('reports.monthly_breakdown') }}</h3>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead>
                <tr class="border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
                    <th class="px-4 py-3 text-left font-medium text-gray-500 dark:text-gray-400">{{ _('reports.month') }}</th>
                    <th class="px-4 py-3 text-right font-medium text-gray-500 dark:text-gray-400">{{ _('reports.amount') }} (KZT)</th>
                    <th class="px-4 py-3 text-center font-medium text-gray-500 dark:text-gray-400">{{ _('reports.count') }}</th>
                    <th class="px-4 py-3 text-right font-medium text-gray-500 dark:text-gray-400">{{ _('reports.avg_per_transaction') }}</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                {% for row in data.monthly %}
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                    <td class="px-4 py-3 font-medium text-gray-900 dark:text-white">{{ row.month }}</td>
                    <td class="px-4 py-3 text-right font-mono text-gray-700 dark:text-gray-300">{{ "{:,.0f}".format(row.total) }}</td>
                    <td class="px-4 py-3 text-center text-gray-500 dark:text-gray-400">{{ row.count }}</td>
                    <td class="px-4 py-3 text-right font-mono text-gray-500 dark:text-gray-400">
                        {% if row.count > 0 %}
                        {{ "{:,.0f}".format(row.total / row.count) }}
                        {% else %}
                        —
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="bg-gray-50 dark:bg-gray-900/50 border-t-2 border-gray-300 dark:border-gray-600">
                    <td class="px-4 py-3 font-semibold text-gray-900 dark:text-white">{{ _('reports.total') }}</td>
                    <td class="px-4 py-3 text-right font-mono font-bold text-gray-900 dark:text-white">{{ "{:,.0f}".format(data.grand_total) }}</td>
                    <td class="px-4 py-3 text-center font-semibold text-gray-900 dark:text-white">{{ data.total_count }}</td>
                    <td class="px-4 py-3 text-right font-mono font-semibold text-gray-500 dark:text-gray-400">
                        {% if data.total_count > 0 %}
                        {{ "{:,.0f}".format(data.grand_total / data.total_count) }}
                        {% else %}
                        —
                        {% endif %}
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
{% endif %}

<!-- Chart.js Scripts -->
{% if data.by_category or data.monthly %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isDark = document.documentElement.classList.contains('dark');
    const textColor = isDark ? '#9ca3af' : '#6b7280';
    const gridColor = isDark ? 'rgba(75, 85, 99, 0.3)' : 'rgba(229, 231, 235, 0.8)';

    const categoryColors = {
        'fuel': '#3b82f6',
        'parts': '#f97316',
        'service': '#22c55e',
        'insurance': '#a855f7',
        'tax': '#ef4444',
        'fine': '#ec4899',
        'parking': '#06b6d4',
        'toll': '#6366f1',
        'washing': '#14b8a6',
        'other': '#6b7280'
    };

    {% if data.by_category %}
    // Category Doughnut Chart
    const categoryCtx = document.getElementById('categoryChart');
    if (categoryCtx) {
        const categoryLabels = {{ data.by_category | map(attribute='category') | list | tojson }};
        const categoryValues = {{ data.by_category | map(attribute='total') | list | tojson }};
        const categoryBgColors = categoryLabels.map(c => categoryColors[c] || '#6b7280');

        new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
                labels: categoryLabels.map(l => {
                    // Capitalize first letter
                    return l.charAt(0).toUpperCase() + l.slice(1);
                }),
                datasets: [{
                    data: categoryValues,
                    backgroundColor: categoryBgColors,
                    borderColor: isDark ? '#1f2937' : '#ffffff',
                    borderWidth: 2,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '55%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: textColor,
                            padding: 16,
                            usePointStyle: true,
                            pointStyleWidth: 8,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const pct = ((value / total) * 100).toFixed(1);
                                return context.label + ': ' + value.toLocaleString() + ' KZT (' + pct + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}

    {% if data.monthly %}
    // Monthly Trend Bar Chart
    const monthlyCtx = document.getElementById('monthlyChart');
    if (monthlyCtx) {
        const monthLabels = {{ data.monthly | map(attribute='month') | list | tojson }};
        const monthlyTotals = {{ data.monthly | map(attribute='total') | list | tojson }};
        const monthlyCounts = {{ data.monthly | map(attribute='count') | list | tojson }};

        new Chart(monthlyCtx, {
            type: 'bar',
            data: {
                labels: monthLabels.map(l => {
                    const d = new Date(l + '-01');
                    return d.toLocaleDateString('{{ lang }}', {month: 'short', year: '2-digit'});
                }),
                datasets: [
                    {
                        label: '{{ _("reports.amount") }}',
                        data: monthlyTotals,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1,
                        borderRadius: 4,
                        yAxisID: 'y'
                    },
                    {
                        label: '{{ _("reports.count") }}',
                        data: monthlyCounts,
                        type: 'line',
                        borderColor: isDark ? 'rgb(156, 163, 175)' : 'rgb(107, 114, 128)',
                        backgroundColor: isDark ? 'rgba(156, 163, 175, 0.1)' : 'rgba(107, 114, 128, 0.1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        fill: false,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.dataset.yAxisID === 'y') {
                                    return '{{ _("reports.amount") }}: ' + context.parsed.y.toLocaleString() + ' KZT';
                                } else {
                                    return '{{ _("reports.count") }}: ' + context.parsed.y;
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { color: textColor, font: { size: 11 } }
                    },
                    y: {
                        position: 'left',
                        beginAtZero: true,
                        grid: { color: gridColor },
                        ticks: {
                            color: textColor,
                            font: { size: 11 },
                            callback: function(v) {
                                if (v >= 1000000) return (v / 1000000).toFixed(1) + 'M';
                                if (v >= 1000) return (v / 1000).toFixed(0) + 'k';
                                return v;
                            }
                        }
                    },
                    y1: {
                        position: 'right',
                        beginAtZero: true,
                        grid: { drawOnChartArea: false },
                        ticks: {
                            color: textColor,
                            font: { size: 11 },
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
    {% endif %}
});
</script>
{% endif %}
{% endblock %}
